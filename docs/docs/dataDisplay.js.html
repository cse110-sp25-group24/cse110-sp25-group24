<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: dataDisplay.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: dataDisplay.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { cardTemplate } from "./cardTemplate.js";
import { isEmptyDB } from "./dataHandlingFunctions.js";
import { deleteMemory } from "./dataHandlingFunctions.js";

// Store and Display a "Memory" using IndexedDB Issue # 30

// making sure all the content is loaded before handling the DB
window.addEventListener("DOMContentLoaded", () => {
  const request = indexedDB.open("MemoryDB", 1); // opening DB version 1

  // if database does not exist
  request.onupgradeneeded = (event) => {
    const db = request.result;

    if (!db.objectStoreNames.contains("memories")) {
      const store = db.createObjectStore("memories", {
        keyPath: "post_id",
        autoIncrement: true,
      });

      store.createIndex("dateCreated", "dateCreated", { unique: false }); // for sorting by date/getting most recent
    }
  };

  let db; // NOTE FOR DISCUSSION: NOT PERSISTED ATM?

  request.onsuccess = (event) => {
    db = event.target.result;
    displayAllMemories(db);
  };

  request.onerror = (event) => {
    console.error("db err"); // works so far, seen
  };

  // event listeners to do the filtering logic
  const moodChange = document.getElementById("mood-search");

  // filtering logic should only apply if there is a filter bar
  if (moodChange) {
    moodChange.addEventListener("change", () => {
      displayAllMemories(db);
    });
  }
});

/**
 * This function is written to display all the memories from date descending.
 *
 * There are additional filters--mood and search bar (currently only mood)
 *
 * @param {IDBDatabase} db Database instance
 *
 */
function displayAllMemories(db) {
  isEmptyDB(db).then((empty) => {
    const display = document.querySelector("memories-grid");
    display.innerHTML = ``; // to clear out the current cards
    if (empty) {
      return;
    } else {
      // getting the filters
      const currentMood = document.getElementById("mood-search");
      let moodFilter;
      if (currentMood) {
        moodFilter = currentMood.value;
      } else {
        moodFilter = "All Moods"; // display all by default
      }
      const tx = db.transaction("memories", "readonly");
      const store = tx.objectStore("memories").index("dateCreated");
      const request = store.openCursor(null, "prev");
      let cnt = 0;
      request.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
          cnt += 1;
          const post = cursor.value;
          if (moodFilter == "All Moods" || post.mood == moodFilter) {
            //create a card for the post
            const card = document.createElement("memory-data");
            card.setAttribute("card_id", post.post_id);
            card.setAttribute("img", post.image);
            card.setAttribute("img_alt", post.description || "memory image");
            card.setAttribute("date", post.dateCreated);
            card.setAttribute("mood", post.mood);
            card.setAttribute("title", post.title);
            card.setAttribute("link", post.link);
            card.setAttribute("description", post.description);
            card.setAttribute(
              "location",
              post.location || "No Location Provided",
            );

            display.appendChild(card);
            setTimeout(() => {
              deleteListener(card, post.post_id, db);
              editListener(card, post.post_id, db);
            }, 0);
          }
          cursor.continue();
        }
      };

      request.onerror = () => {
        console.error("unable to open cursor");
      };
    }
  });
}

/**
 * This function adds a delete listener to the card element.
 *
 * @param {*} cardElement to remove from DOM
 * @param {*} id to delete from IndexedDB
 * @param {*} db Database instance
 */
function deleteListener(cardElement, id, db) {
  const deleteBtn = cardElement.shadowRoot.querySelector("#delete-btn");
  if (deleteBtn) {
    deleteBtn.addEventListener("click", () => {
      const confirmed = window.confirm(
        "Are you sure you want to delete this memory?",
      );
      if (confirmed) {
        deleteMemory(id, db);
        cardElement.remove(); // Remove from DOM
      }
    });
  }
}

/**
 * This function adds an edit listener on the card element.
 *
 * @param {*} cardElement to edit from DOM
 * @param {*} id to edit from IndexedDB
 * @param {*} db Database instance
 */
function editListener(cardElement, id, db) {
  const editBtn = cardElement.shadowRoot.querySelector("#edit-btn");
  if (editBtn) {
    editBtn.addEventListener("click", () => {
      // store post id into local storage
      localStorage.setItem("postId", id);
      window.location.href = "create.html";
    });
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#API_KEY_STORAGE">API_KEY_STORAGE</a></li><li><a href="global.html#addMarker">addMarker</a></li><li><a href="global.html#addMemory">addMemory</a></li><li><a href="global.html#cardTemplate">cardTemplate</a></li><li><a href="global.html#changeImg">changeImg</a></li><li><a href="global.html#confirmSafety">confirmSafety</a></li><li><a href="global.html#createCardContent">createCardContent</a></li><li><a href="global.html#createCardMeta">createCardMeta</a></li><li><a href="global.html#createMemoryPhoto">createMemoryPhoto</a></li><li><a href="global.html#deleteAllMemories">deleteAllMemories</a></li><li><a href="global.html#deleteListener">deleteListener</a></li><li><a href="global.html#deleteMemory">deleteMemory</a></li><li><a href="global.html#displayAllMemories">displayAllMemories</a></li><li><a href="global.html#editListener">editListener</a></li><li><a href="global.html#fileToDataUrl">fileToDataUrl</a></li><li><a href="global.html#fillForm">fillForm</a></li><li><a href="global.html#getAllLocations">getAllLocations</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initAutocomplete">initAutocomplete</a></li><li><a href="global.html#initCreate">initCreate</a></li><li><a href="global.html#initDB">initDB</a></li><li><a href="global.html#initMap">initMap</a></li><li><a href="global.html#initMapDisplay">initMapDisplay</a></li><li><a href="global.html#insertAPIKey">insertAPIKey</a></li><li><a href="global.html#isEmptyDB">isEmptyDB</a></li><li><a href="global.html#loadGoogleMaps">loadGoogleMaps</a></li><li><a href="global.html#map">map</a></li><li><a href="global.html#onPlaceChanged">onPlaceChanged</a></li><li><a href="global.html#retrieveMemory">retrieveMemory</a></li><li><a href="global.html#submitForm">submitForm</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Jun 11 2025 02:09:43 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
